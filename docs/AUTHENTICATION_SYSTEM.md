# Syst√®me d'authentification cryptographique RSA

[‚Üê Retour au README principal](../README.md)

## üìã Vue d'ensemble

Le syst√®me d'authentification permet au serveur RogueBB de cr√©er des fichiers de mani√®re s√©curis√©e sur les n≈ìuds phpBB en utilisant la cryptographie asym√©trique RSA avec signature num√©rique.

## üîê Architecture de s√©curit√©

### Composants

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Serveur RogueBB (Poss√®de la cl√© priv√©e)                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  1. G√©n√®re un token avec timestamp                ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  2. Signe le token avec la cl√© priv√©e RSA         ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  3. Envoie token + signature + donn√©es au n≈ìud    ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº HTTPS POST
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  N≈ìud phpBB (Poss√®de la cl√© publique)                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  1. Re√ßoit token + signature + donn√©es            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  2. V√©rifie la signature avec la cl√© publique     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  3. V√©rifie le timestamp (anti-replay)            ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  4. V√©rifie le serveur_id (optionnel)             ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ  5. Cr√©e le fichier SI tout est valide            ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Avantages de cette approche

‚úÖ **Asym√©trique** : Seul le serveur RogueBB peut signer (cl√© priv√©e)  
‚úÖ **V√©rifiable** : N'importe quel n≈ìud peut v√©rifier (cl√© publique)  
‚úÖ **Anti-replay** : Les tokens ont un timestamp limit√© (5 minutes par d√©faut)  
‚úÖ **Robuste** : Bas√© sur RSA-2048 + SHA256  
‚úÖ **Tra√ßable** : Tous les √©v√©nements sont logg√©s  

## üîë G√©n√©ration des cl√©s

### Cl√©s d√©j√† existantes

Le projet inclut d√©j√† une paire de cl√©s RSA :

```
roguebb/server/
‚îú‚îÄ‚îÄ private_key.pem  ‚Üí Cl√© priv√©e (GARDEZ SECR√àTE !)
‚îî‚îÄ‚îÄ public_key.pem   ‚Üí Cl√© publique (distribuez-la)
```

### R√©g√©n√©rer les cl√©s (si n√©cessaire)

```bash
cd roguebb/server
python3 generate_keys.py
```

Cela g√©n√®re :
- **private_key.pem** : Cl√© priv√©e RSA 2048 bits (√† prot√©ger !)
- **public_key.pem** : Cl√© publique RSA (√† distribuer aux n≈ìuds)

### Distribution de la cl√© publique

La cl√© publique est automatiquement copi√©e dans l'extension :

```bash
cp roguebb/server/public_key.pem activitycontrol/data/roguebb_public_key.pem
```

## üì° API: √âcriture authentifi√©e

### Endpoint

```
POST /app.php/ac_authenticated_write
```

### Format de requ√™te

```json
{
  "filename": "server_config.json",
  "content": "{\"server\":\"roguebb-main\",\"version\":\"1.0.0\"}",
  "token": "{\"timestamp\":1698765432,\"server_id\":\"roguebb-main\"}",
  "signature": "base64_encoded_signature_here..."
}
```

### Champs requis

| Champ | Type | Description |
|-------|------|-------------|
| `filename` | string | Nom du fichier (alphanum + `-_.` uniquement) |
| `content` | string | Contenu du fichier (peut √™tre JSON, texte, etc.) |
| `token` | string | Token JSON avec `timestamp` et `server_id` |
| `signature` | string | Signature RSA du token encod√©e en Base64 |

### R√©ponses

#### Succ√®s (200 OK)

```json
{
  "status": "ok",
  "message": "File created successfully",
  "filename": "server_config.json",
  "size": 45,
  "hash": "sha256_hash_of_file",
  "timestamp": 1698765432
}
```

#### Erreurs

**403 Forbidden** - Authentification √©chou√©e
```json
{
  "status": "error",
  "message": "Authentication failed or file creation error",
  "filename": "server_config.json"
}
```

**400 Bad Request** - Donn√©es invalides
```json
{
  "status": "error",
  "message": "Missing required field: signature"
}
```

**405 Method Not Allowed** - M√©thode HTTP invalide
```json
{
  "status": "error",
  "message": "Only POST requests are allowed"
}
```

## üêç Exemple Python (Serveur RogueBB)

### Code complet d'√©criture authentifi√©e

```python
import json
import time
import base64
from cryptography.hazmat.primitives import hashes, serialization
from cryptography.hazmat.primitives.asymmetric import padding
import requests

# Charger la cl√© priv√©e
with open('private_key.pem', 'rb') as f:
    private_key = serialization.load_pem_private_key(f.read(), password=None)

# Cr√©er le token
token_data = {
    'timestamp': int(time.time()),
    'server_id': 'roguebb-main'
}
token_json = json.dumps(token_data, separators=(',', ':'))

# Signer le token
signature = private_key.sign(
    token_json.encode('utf-8'),
    padding.PKCS1v15(),
    hashes.SHA256()
)
signature_b64 = base64.b64encode(signature).decode('utf-8')

# Pr√©parer les donn√©es du fichier
file_content = json.dumps({
    'server': 'roguebb-main',
    'version': '1.0.0',
    'last_update': int(time.time())
})

# Envoyer la requ√™te
response = requests.post(
    'http://forum.example.com/app.php/ac_authenticated_write',
    json={
        'filename': 'server_config.json',
        'content': file_content,
        'token': token_json,
        'signature': signature_b64
    },
    headers={'Content-Type': 'application/json'}
)

print(response.json())
```

### Fonction r√©utilisable

```python
def write_authenticated_file(node_url, filename, content, private_key_path='private_key.pem'):
    """
    √âcrit un fichier sur un n≈ìud phpBB de mani√®re authentifi√©e
    
    Args:
        node_url: URL du n≈ìud phpBB (ex: http://forum.example.com)
        filename: Nom du fichier √† cr√©er
        content: Contenu du fichier (string)
        private_key_path: Chemin vers la cl√© priv√©e RSA
        
    Returns:
        dict: R√©ponse du serveur
    """
    # Charger la cl√© priv√©e
    with open(private_key_path, 'rb') as f:
        private_key = serialization.load_pem_private_key(f.read(), password=None)
    
    # Cr√©er et signer le token
    token_data = {
        'timestamp': int(time.time()),
        'server_id': 'roguebb-main'
    }
    token_json = json.dumps(token_data, separators=(',', ':'))
    
    signature = private_key.sign(
        token_json.encode('utf-8'),
        padding.PKCS1v15(),
        hashes.SHA256()
    )
    signature_b64 = base64.b64encode(signature).decode('utf-8')
    
    # Envoyer la requ√™te
    response = requests.post(
        f'{node_url}/app.php/ac_authenticated_write',
        json={
            'filename': filename,
            'content': content,
            'token': token_json,
            'signature': signature_b64
        },
        headers={'Content-Type': 'application/json'},
        timeout=10
    )
    
    return response.json()

# Utilisation
result = write_authenticated_file(
    'http://forum.example.com',
    'sync_status.json',
    json.dumps({'synced': True, 'timestamp': int(time.time())})
)
print(result)
```

## üîí S√©curit√©

### Protection de la cl√© priv√©e

```bash
# Permissions strictes
chmod 600 roguebb/server/private_key.pem

# Ne jamais committer la cl√© priv√©e
echo "roguebb/server/private_key.pem" >> .gitignore
```

### Validations c√¥t√© phpBB

Le service `server_authenticator` v√©rifie :

1. **Signature valide** : La signature correspond-elle au token ?
2. **Timestamp r√©cent** : Le token a-t-il moins de 5 minutes ?
3. **Timestamp coh√©rent** : Le timestamp n'est pas dans le futur
4. **Server ID** : L'ID du serveur correspond (optionnel)
5. **Nom de fichier s√ªr** : Pas de `../`, uniquement alphanum + `-_.`
6. **Extension autoris√©e** : `.json`, `.txt`, `.log`, `.dat` uniquement

### Logs de s√©curit√©

Tous les √©v√©nements sont logg√©s dans phpBB :

```php
// Logs critiques
'AC_AUTH_SIGNATURE_MISMATCH'    // Signature invalide
'AC_AUTH_TOKEN_EXPIRED'         // Token trop vieux
'AC_AUTH_TOKEN_FUTURE'          // Token du futur
'AC_AUTH_SERVER_ID_MISMATCH'    // ID serveur incorrect
'AC_AUTH_UNSAFE_FILENAME'       // Nom de fichier dangereux
'AC_AUTH_FILE_EXISTS'           // Fichier existe d√©j√†

// Logs admin
'AC_AUTH_FILE_CREATED'          // Fichier cr√©√© avec succ√®s
'AC_AUTH_KEY_INSTALLED'         // Nouvelle cl√© publique install√©e
'AC_AUTH_KEY_REVOKED'           // Cl√© publique r√©voqu√©e
```

## üß™ Tests

### Test manuel avec curl

```bash
# Vous aurez besoin du token et signature g√©n√©r√©s en Python
curl -X POST http://localhost:8080/forum/app.php/ac_authenticated_write \
  -H "Content-Type: application/json" \
  -d '{
    "filename": "test.json",
    "content": "{\"test\":true}",
    "token": "{\"timestamp\":1698765432,\"server_id\":\"roguebb-main\"}",
    "signature": "YOUR_BASE64_SIGNATURE_HERE"
  }'
```

### Script de test complet

```python
#!/usr/bin/env python3
"""
Test du syst√®me d'authentification RSA
"""
import sys
sys.path.append('roguebb/server')

from write_authenticated_file import write_authenticated_file

# Test 1: Fichier simple
print("Test 1: Cr√©ation d'un fichier simple")
result = write_authenticated_file(
    'http://localhost:8080/forum',
    'test_simple.json',
    '{"test": "hello world"}'
)
print(f"  R√©sultat: {result}\n")

# Test 2: Fichier avec donn√©es complexes
print("Test 2: Fichier avec donn√©es complexes")
import json
import time
complex_data = json.dumps({
    'server_info': {
        'name': 'roguebb-main',
        'version': '1.0.0',
        'nodes_count': 5
    },
    'stats': {
        'total_ips': 1234,
        'active_bans': 567
    },
    'timestamp': int(time.time())
})
result = write_authenticated_file(
    'http://localhost:8080/forum',
    'server_status.json',
    complex_data
)
print(f"  R√©sultat: {result}\n")

# Test 3: Token expir√© (devrait √©chouer)
print("Test 3: Token expir√© (devrait √©chouer)")
# Modifier manuellement le timestamp dans le code pour tester

print("‚úì Tests termin√©s")
```

## üìö R√©f√©rence PHP

### Service `server_authenticator`

#### M√©thodes publiques

```php
// V√©rifier une signature
bool verify_signature(string $data, string $signature)

// V√©rifier un token avec timestamp
bool verify_token(string $token, string $signature, int $max_age = 300)

// Cr√©er un fichier authentifi√©
bool create_authenticated_file(string $filename, string $content, string $token, string $signature)

// Obtenir le hash d'un fichier
string|false get_file_hash(string $filename)

// R√©voquer la cl√© publique actuelle
bool revoke_public_key()

// Installer une nouvelle cl√© publique
bool install_public_key(string $public_key_content)
```

### Configuration

```php
// Autoriser l'√©crasement de fichiers existants
$config->set('ac_allow_file_overwrite', 1);

// D√©finir l'ID du serveur attendu
$config->set('ac_roguebb_server_id', 'roguebb-main');
```

## üöÄ Cas d'usage

### 1. Synchronisation de configuration

Le serveur RogueBB peut pousser sa configuration vers tous les n≈ìuds :

```python
config = json.dumps({
    'sync_interval': 3600,
    'webhook_enabled': True,
    'reporting_enabled': True
})

for node in nodes:
    write_authenticated_file(node['url'], 'roguebb_config.json', config)
```

### 2. Mise √† jour de liste d'IPs

```python
ips_data = json.dumps({
    'version': 123,
    'ips': ['1.2.3.4', '5.6.7.8'],
    'updated_at': time.time()
})

for node in nodes:
    write_authenticated_file(node['url'], 'ip_list_v123.json', ips_data)
```

### 3. D√©ploiement de r√®gles

```python
rules = json.dumps({
    'min_posts_for_links': 10,
    'quarantine_posts': True,
    'auto_ban_threshold': 5
})

for node in nodes:
    write_authenticated_file(node['url'], 'security_rules.json', rules)
```

## üîÑ R√©vocation et rotation des cl√©s

### R√©voquer l'ancienne cl√©

```php
// Via l'ACP ou script
$authenticator->revoke_public_key();
// Renomme la cl√© en roguebb_public_key.pem.revoked.1698765432
```

### Installer une nouvelle cl√©

```php
$new_public_key = file_get_contents('new_public_key.pem');
$authenticator->install_public_key($new_public_key);
```

### Workflow complet de rotation

1. **G√©n√©rer nouvelle paire** :
   ```bash
   cd roguebb/server
   python3 generate_keys.py
   mv private_key.pem private_key_new.pem
   mv public_key.pem public_key_new.pem
   ```

2. **Distribuer la nouvelle cl√© publique** aux n≈ìuds

3. **Basculer** sur la nouvelle cl√© priv√©e pour signer

4. **R√©voquer** les anciennes cl√©s publiques sur les n≈ìuds

## üéØ Avantages vs alternatives

### vs Cl√©s sym√©triques (HMAC)
- ‚úÖ Pas besoin de secret partag√© sur les n≈ìuds
- ‚úÖ La cl√© publique peut √™tre commit√©e dans Git
- ‚úÖ R√©vocation facile sans changer tous les n≈ìuds

### vs API Key simple
- ‚úÖ Impossible de forger un token sans la cl√© priv√©e
- ‚úÖ Protection anti-replay avec timestamp
- ‚úÖ Signature cryptographiquement prouvable

### vs TLS Client Certificates
- ‚úÖ Plus simple √† impl√©menter
- ‚úÖ Pas besoin de configuration serveur web complexe
- ‚úÖ Fonctionne avec n'importe quel h√©bergement PHP

---

[‚Üê Retour au README principal](../README.md) | [üìö Documentation RogueBB](roguebb/docs/INDEX.md)

**Derni√®re mise √† jour** : 27 octobre 2025
